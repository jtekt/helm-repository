stages:
  - release

image: moreillon/ci-dind:v1.0.3
services:
  - name: docker:24.0.7-dind

release-job:
  stage: release
  only:
    - internal
  tags:
    - internal-dind
  script:
    - >
      for d in */ ; do
        read CHART_ARCHIVE <<< $(helm package . | awk -F'Successfully packaged chart and saved it to: ' '{print $2}')
        curl --data-binary "@${CHART_ARCHIVE}" http://172.16.98.151:30588/api/charts
      done
